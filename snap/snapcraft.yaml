name: s32g274a-rdb2
summary: NXP s32g 274a rdb2 support package
description: |
 Support files for booting s32g 274a rdb2 board
version: 20-1
type: gadget

base: core20

architectures:
  - build-on: [amd64, arm64]
    run-on: arm64

confinement: strict
grade: stable

environment:
    LD_LIBRARY_PATH: ${SNAP}/usr/lib
    PATH: ${SNAP}/bin:${PATH}
    OPTEE_LIB: $SNAP/lib/optee_armtz
    OPTEE_FS_PARENT_PATH: $SNAP_COMMON

apps:
    tee-supplicant:
        adapter: none
        command: usr/sbin/tee-supplicant
        daemon: simple
        plugs:
            - tee

parts:
    arm-trusted-firmware:
        after:
            - optee-os
            - u-boot
        plugin: nil
        source: https://source.codeaurora.org/external/autobsps32/arm-trusted-firmware.git
        source-type: git
        source-tag: bsp29.0-2.3
        source-depth: 1
        override-build: |
            platform="s32g"
            make \
                ARCH=aarch64 \
                CROSS_COMPILE=aarch64-linux-gnu- \
                PLAT="s32g" \
                BUILD_BASE=${SNAPCRAFT_PART_BUILD}/build \
                BL32=${SNAPCRAFT_STAGE}/tee-header_v2.bin \
                BL32_EXTRA1=${SNAPCRAFT_STAGE}/tee-pager_v2.bin \
                BL33=${SNAPCRAFT_STAGE}/u-boot.bin \
                SPD=opteed \
                -j$(nproc)
            cp ${SNAPCRAFT_PART_BUILD}/build/${platform}/release/fip.s32 \
               ${SNAPCRAFT_PART_INSTALL}/imx-boot.bin
            dd if=${SNAPCRAFT_PART_INSTALL}/imx-boot.bin of=${SNAPCRAFT_PART_INSTALL}/sbl_header.bin bs=256 count=1 seek=0 conv=fsync,notrunc
            dd if=${SNAPCRAFT_PART_INSTALL}/imx-boot.bin of=${SNAPCRAFT_PART_INSTALL}/sbl.bin bs=512K seek=512 iflag=skip_bytes oflag=seek_bytes conv=fsync,notrunc

        organize:
            '*': blobs/

    # optee signing keys: used for signing ot Trusted Applications
    optee-keys:
        plugin: dump
        source: https://git.launchpad.net/~ondrak/+git/dev-keys
        source-type: git
        source-branch: ta-keys
        organize:
            '*': ta-keys/
        prime:
             - -*

    optee-os:
        after:
            - optee-fde
            - optee-keys
        plugin: nil
        source: https://source.codeaurora.org/external/autobsps32/optee_os
        source-type: git
        source-tag: bsp29.0-3.11
        source-depth: 1
        override-build: |
            export ARCH="arm"
            export CROSS_COMPILE="aarch64-linux-gnu-"
            export CROSS_COMPILE_core="aarch64-linux-gnu-"
            export CROSS_COMPILE_ta_arm64="aarch64-linux-gnu-"
            export CFG_USER_TA_TARGETS="ta_arm64"
            export CFG_ARM64_core=y
            export DEBUG=0 \
            export CFG_TEE_CORE_LOG_LEVEL=1 \
            export CFG_TEE_TA_LOG_LEVEL=1 \
            export CFG_TEE_BENCHMARK=n
            # set NXP platform
            export PLATFORM=s32g
            # add optee-fde TA
            cp -r ${SNAPCRAFT_STAGE}/optee-fde/ta/fde_key_handler ${SNAPCRAFT_PART_BUILD}/ta/
            # determine keys to be used
            TA_PUBLIC_KEY="${SNAPCRAFT_STAGE}/ta-keys/ta_public.pem"
            TA_SIGN_KEY="${SNAPCRAFT_STAGE}/ta-keys/ta_private.pem"
            make O=${SNAPCRAFT_PART_BUILD}/out -j$(nproc)
            make O=${SNAPCRAFT_PART_BUILD}/out -j$(nproc) \
                 CFG_EARLY_TA=y \
                 EARLY_TA_PATHS="out/ta/pkcs11/fd02c9da-306c-48c7-a49c-bbd827ae86ee.stripped.elf \
                                 out/ta/trusted_keys/f04a0fe7-1f5d-4b9b-abf7-619b85b4ce8c.stripped.elf \
                                 out/ta/fde_key_handler/fd1b2a86-3668-11eb-adc1-0242ac120002.stripped.elf"
            cp \
                 ${SNAPCRAFT_PART_BUILD}/out/core/tee-*.bin \
                 ${SNAPCRAFT_PART_INSTALL}/
            cp \
                 ${SNAPCRAFT_PART_BUILD}/out/core/tee.bin \
                 ${SNAPCRAFT_PART_INSTALL}/
        prime:
            - -*

    optee-client:
        plugin: nil
        source: https://github.com/OP-TEE/optee_client.git
        source-type: git
        source-tag: "3.11.0"
        source-depth: 1
        override-build: |
            export ARCH="arm64"
            export CROSS_COMPILE="aarch64-linux-gnu-"
            export CFG_TEE_CLIENT_LOAD_PATH=""
            export CFG_TA_TEST_PATH=0
            export CFG_TEE_SUPP_LOG_LEVEL=0
            export DESTDIR=${SNAPCRAFT_PART_INSTALL}
            make -j$(nproc)
            make install
        stage:
            - usr/sbin
            - usr/lib/lib*so*

    optee-fde:
        plugin: dump
        source: git+ssh://git.launchpad.net/~ondrak/+git/optee-uc-fde
        source-type: git
        organize:
            '*': optee-fde/
        prime:
            - -*

    pub-signing-key:
        plugin: dump
        source: https://git.launchpad.net/~ondrak/+git/dev-keys
        source-type: git
        source-branch: master
        stage:
            - u-boot-pubkey.dtsi
        prime:
            - -*

    u-boot:
        after:
            - pub-signing-key
        plugin: nil
        source: https://git.launchpad.net/~ondrak/+git/u-boot
        source-type: git
        source-tag: bsp29.0-2020.04-uc
        source-depth: 1
        override-build: |
            # copy in place dtsi with pub part of kernel signing key
            cp ${SNAPCRAFT_STAGE}/u-boot-pubkey.dtsi \
               ${SNAPCRAFT_PART_BUILD}/arch/arm/dts/u-boot-pubkey.dtsi
            # Add GIT revision to the local version
            head=`git rev-parse --verify --short HEAD 2> /dev/null`
            printf "%s%s%s" "bsp29.0-3.11" +g $head > .scmversion
            export CROSS_COMPILE="aarch64-linux-gnu-"
            export CC="aarch64-linux-gnu-gcc"
            export ARCH=arm64
            make s32g274ardb2_defconfig
            make -j$(nproc)
            cp u-boot.bin ${SNAPCRAFT_PART_INSTALL}
            # copy tools/mkimage tool for imx-boot stage
            mkdir -p ${SNAPCRAFT_PART_INSTALL}/tools
            cp tools/mkimage ${SNAPCRAFT_PART_INSTALL}/tools
            tools/mkenvimage -r -s 4096 -o ${SNAPCRAFT_PART_INSTALL}/boot.sel - < /dev/null
            touch ${SNAPCRAFT_PART_INSTALL}/uboot.conf
        prime:
            - boot.sel
            - uboot.conf

build-packages:
    - bison
    - build-essential
    - device-tree-compiler
    - flex
    - gcc-aarch64-linux-gnu
    - libxml2-dev
    - libssl-dev
    - python3
    - python3-crypto
    - python3-pyelftools
    - python3-pycryptodome
    - wget
    - zlib1g-dev
